{% extends 'base.html' %}
{% load calendar_filters %}

{% block title %}Calendário - Sistema Seja Sua{% endblock %}

{% block nav_calendar %}active{% endblock %}

{% block page_title %}Calendário{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header">
        <div class="month-navigation">
            <a href="?month={{ prev_month }}&year={{ prev_year }}" class="nav-btn">‹</a>
            <h2 class="month-title">{{ month_name }} {{ year }}</h2>
            <a href="?month={{ next_month }}&year={{ next_year }}" class="nav-btn">›</a>
        </div>
        <div class="calendar-actions">
            <a href="{% url 'calendar_app:event_create' %}" class="btn">➕ Novo Evento</a>
        </div>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <!-- Days of week header -->
        <div class="calendar-weekdays">
            <div class="weekday">Dom</div>
            <div class="weekday">Seg</div>
            <div class="weekday">Ter</div>
            <div class="weekday">Qua</div>
            <div class="weekday">Qui</div>
            <div class="weekday">Sex</div>
            <div class="weekday">Sáb</div>
        </div>

        <!-- Calendar days -->
        <div class="calendar-days">
            {% for week in calendar %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="calendar-day empty-day"></div>
                    {% else %}
                        <div class="calendar-day {% if day == today.day and month == today.month and year == today.year %}today{% endif %}"
                             data-date="{{ year }}-{{ month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}">
                            <div class="day-header">
                                <span class="day-number">{{ day }}</span>
                                <button class="add-event-btn" onclick="createEvent('{{ year }}-{{ month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}')">+</button>
                            </div>
                            <div class="day-events">
                                {% if day in events_by_date %}
                                    {% for event in events_by_date|get_item:day %}
                                        <div class="event-item"
                                             style="border-left: 3px solid {{ event.color|default:'#c9a961' }};"
                                             onclick="showEventDetails({{ event.id }})">
                                            <span class="event-time">
                                                {% if event.all_day %}
                                                    Dia inteiro
                                                {% elif event.start_time %}
                                                    {{ event.start_time|time:'H:i' }}
                                                {% endif %}
                                            </span>
                                            <span class="event-title">{{ event.title }}</span>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Detalhes do Evento</h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Event details will be loaded here -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Fechar</button>
            <a id="editEventBtn" href="#" class="btn">Editar</a>
            <button type="button" id="deleteEventBtn" class="btn btn-danger" onclick="deleteEvent()">Excluir</button>
        </div>
    </div>
</div>

<style>
.calendar-container {
    max-width: 100%;
    margin: 0 auto;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--white);
    border-radius: 8px;
    border: 1px solid var(--beige-medium);
}

.month-navigation {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.month-title {
    font-size: 1.75rem;
    color: var(--brown-dark);
    margin: 0;
}

.nav-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--beige-light);
    border-radius: 50%;
    text-decoration: none;
    color: var(--brown-dark);
    font-size: 1.5rem;
    font-weight: bold;
    transition: all 0.2s;
}

.nav-btn:hover {
    background: var(--accent-gold);
    color: var(--white);
}

.calendar-grid {
    background: var(--white);
    border-radius: 8px;
    border: 1px solid var(--beige-medium);
    overflow: hidden;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: var(--beige-medium);
    border-bottom: 2px solid var(--beige-dark);
}

.weekday {
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    color: var(--brown-dark);
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--beige-light);
}

.calendar-day {
    min-height: 120px;
    background: var(--white);
    padding: 0.5rem;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.calendar-day:hover {
    background: var(--beige-light);
}

.calendar-day.empty-day {
    background: #f9f9f9;
    cursor: default;
}

.calendar-day.empty-day:hover {
    background: #f9f9f9;
}

.calendar-day.today {
    background: #fff9f0;
    border: 2px solid var(--accent-gold);
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.day-number {
    font-weight: 600;
    color: var(--brown-dark);
    font-size: 0.9rem;
}

.calendar-day.today .day-number {
    background: var(--accent-gold);
    color: var(--white);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-event-btn {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid var(--beige-dark);
    background: var(--white);
    color: var(--brown-text);
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s;
}

.calendar-day:hover .add-event-btn {
    opacity: 1;
}

.add-event-btn:hover {
    background: var(--accent-gold);
    color: var(--white);
    border-color: var(--accent-gold);
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.event-item {
    padding: 0.25rem 0.5rem;
    background: var(--beige-light);
    border-radius: 3px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.event-item:hover {
    background: var(--beige-medium);
    transform: translateX(2px);
}

.event-time {
    font-weight: 600;
    color: var(--brown-dark);
    margin-right: 0.25rem;
}

.event-title {
    color: var(--brown-text);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background: var(--white);
    margin: 5% auto;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--beige-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: var(--brown-dark);
}

.modal-close {
    font-size: 2rem;
    font-weight: bold;
    color: var(--brown-text);
    cursor: pointer;
    line-height: 1;
}

.modal-close:hover {
    color: var(--brown-dark);
}

.modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--beige-light);
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.event-detail-row {
    margin-bottom: 1rem;
}

.event-detail-label {
    font-weight: 600;
    color: var(--brown-dark);
    margin-bottom: 0.25rem;
}

.event-detail-value {
    color: var(--brown-text);
}

.btn-danger {
    background: #dc3545;
    color: var(--white);
}

.btn-danger:hover {
    background: #c82333;
}

.messages {
    margin-bottom: 1.5rem;
}

.alert {
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>

<script>
let currentEventId = null;

function createEvent(date) {
    window.location.href = '{% url "calendar_app:event_create" %}?date=' + date;
}

function showEventDetails(eventId) {
    currentEventId = eventId;
    fetch(`/calendar/event/${eventId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalTitle').textContent = data.title;

            let bodyHTML = '';

            if (data.description) {
                bodyHTML += `
                    <div class="event-detail-row">
                        <div class="event-detail-label">Descrição</div>
                        <div class="event-detail-value">${data.description}</div>
                    </div>
                `;
            }

            bodyHTML += `
                <div class="event-detail-row">
                    <div class="event-detail-label">Tipo</div>
                    <div class="event-detail-value">${data.event_type}</div>
                </div>
                <div class="event-detail-row">
                    <div class="event-detail-label">Data</div>
                    <div class="event-detail-value">
                        ${formatDate(data.start_date)}
                        ${data.start_time ? ` às ${data.start_time}` : ''}
                        ${data.all_day ? ' (Dia inteiro)' : ''}
                    </div>
                </div>
            `;

            if (data.location) {
                bodyHTML += `
                    <div class="event-detail-row">
                        <div class="event-detail-label">Local</div>
                        <div class="event-detail-value">${data.location}</div>
                    </div>
                `;
            }

            if (data.collection) {
                bodyHTML += `
                    <div class="event-detail-row">
                        <div class="event-detail-label">Coleção</div>
                        <div class="event-detail-value">${data.collection}</div>
                    </div>
                `;
            }

            bodyHTML += `
                <div class="event-detail-row">
                    <div class="event-detail-label">Sincronização Google Calendar</div>
                    <div class="event-detail-value">${data.sync_enabled ? 'Ativada' : 'Desativada'}</div>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = bodyHTML;
            document.getElementById('editEventBtn').href = `/calendar/event/${eventId}/edit/`;
            document.getElementById('eventModal').style.display = 'block';
        });
}

function closeModal() {
    document.getElementById('eventModal').style.display = 'none';
    currentEventId = null;
}

function deleteEvent() {
    if (confirm('Tem certeza que deseja excluir este evento?')) {
        window.location.href = `/calendar/event/${currentEventId}/delete/`;
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('pt-BR');
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('eventModal');
    if (event.target == modal) {
        closeModal();
    }
}
</script>

{% endblock %}
